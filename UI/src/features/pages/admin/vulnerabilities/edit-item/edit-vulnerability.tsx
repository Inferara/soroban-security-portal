import { FC, useEffect, useState, useRef } from 'react';
import {
  Box,
  Typography,
  TextField,
  Button,
  Paper,
  Divider,
  CardContent,
  CardHeader,
  Avatar,
  useTheme,
  Autocomplete,
  Chip,
  Grid,
  Alert,
  IconButton,
  Tooltip,
} from '@mui/material';
import { AuthContextProps, useAuth } from 'react-oidc-context';
import { Role } from '../../../../../api/soroban-security-portal/models/role';
import { useNavigate } from 'react-router-dom';
import { useEditVulnerability } from './hooks';
import {
  Vulnerability,
  VulnerabilityCategory,
  VulnerabilitySeverity,
  VulnerabilitySource,
  VulnerabilityCategories,
} from '../../../../../api/soroban-security-portal/models/vulnerability';
import BugReportIcon from '@mui/icons-material/BugReport';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import DeleteIcon from '@mui/icons-material/Delete';
import ContentCopyIcon from '@mui/icons-material/ContentCopy';
import { ProtocolItem } from '../../../../../api/soroban-security-portal/models/protocol';
import { AuditorItem } from '../../../../../api/soroban-security-portal/models/auditor';
import { TagItem } from '../../../../../api/soroban-security-portal/models/tag';
import { showError } from '../../../../dialog-handler/dialog-handler';
import { CurrentPageState } from '../../admin-main-window/current-page-slice';
import { environment } from '../../../../../environments/environment';
import { ConfirmDialog } from '../../admin-main-window/confirm-dialog';
import { CompanyItem } from '../../../../../api/soroban-security-portal/models/company';
import { MarkdownEditor } from '../../../../../components/MarkdownEditor';

export const EditVulnerability: FC = () => {
  const [title, setTitle] = useState('');
  const [reportUrl, setReportUrl] = useState('');
  const [description, setDescription] = useState('');
  const [tags, setTags] = useState<TagItem[]>([]);
  const [severity, setSeverity] = useState<VulnerabilitySeverity | null>(null);
  const [protocol, setProtocol] = useState<ProtocolItem | null>(null);
  const [company, setCompany] = useState<CompanyItem | null>(null);
  const [auditor, setAuditor] = useState<AuditorItem | null>(null);
  const [source, setSource] = useState<VulnerabilitySource | null>(null);
  const [category, setCategory] = useState<VulnerabilityCategory | null>(VulnerabilityCategory.Valid);
  const [selectedImages, setSelectedImages] = useState<File[]>([]);
  const [imageError, setImageError] = useState('');
  const [isDragOver, setIsDragOver] = useState(false);
  const imageInputRef = useRef<HTMLInputElement>(null);
  const [isFormLoaded, setIsFormLoaded] = useState(false);
  
  // Confirmation dialog states
  const [existingImageToDelete, setExistingImageToDelete] = useState<string | null>(null);
  const [selectedImageToRemove, setSelectedImageToRemove] = useState<number | null>(null);

  const storageKey = `editVulnerabilityFormData_${window.location.pathname.split('/').pop()}`;

  const currentPageState: CurrentPageState = {
    pageName: 'Edit Vulnerability',
    pageCode: 'editVulnerability',
    pageUrl: window.location.pathname,
    routePath: 'admin/vulnerabilities/edit',
  };

  const { 
    editVulnerability,
    existingImages,
    deleteImage,
    vulnerability, 
    severitiesList,
    tagsList,
    companiesList,
    protocolsList,
    auditorsList,
    sourceList,
    isUploading,
  } = useEditVulnerability({ currentPageState });

  const auth = useAuth();
  const navigate = useNavigate();
  const theme = useTheme();

  // Check if user has permission to edit vulnerabilities
  const canEditVulnerability = (auth: AuthContextProps) => 
    auth.user?.profile.role === Role.Admin || auth.user?.profile.role === Role.Moderator;

  if (!canEditVulnerability(auth)) {
    navigate('/admin/vulnerabilities');
  }

  const handleSetProtocol = (newProtocol: ProtocolItem | null) => {
    setProtocol(newProtocol);
    const company = companiesList.find(c => c.id === newProtocol?.companyId);
    if (company) {
      setCompany(company);
    } else {
      setCompany(null);
    }
  };
  
  // Populate form when vulnerability data is loaded
  useEffect(() => {
    if (vulnerability && severitiesList.length > 0 && tagsList.length > 0 && protocolsList.length > 0 && companiesList.length > 0 && auditorsList.length > 0 && sourceList.length > 0) {
      // Try to load from sessionStorage first
      const savedData = sessionStorage.getItem(storageKey);
      if (savedData) {
        try {
          const parsedData: {
            title?: string;
            reportUrl?: string;
            description?: string;
            category?: number | null;
            severityName?: string;
            tagNames?: string[];
            protocolId?: number;
            auditorId?: number;
            sourceId?: number;
          } = JSON.parse(savedData);
          setTitle(parsedData.title || vulnerability.title);
          setDescription(parsedData.description || vulnerability.description);
          setReportUrl(parsedData.reportUrl || vulnerability.reportUrl || '');
          if (parsedData.category !== undefined && parsedData.category !== null) {
            setCategory(parsedData.category);
          } else {
            setCategory(vulnerability.category);
          }
          
          // Restore severity
          if (parsedData.severityName) {
            const foundSeverity = severitiesList.find(s => s.name === parsedData.severityName);
            setSeverity(foundSeverity || null);
          } else {
            const foundSeverity = severitiesList.find((s: VulnerabilitySeverity) => s.name === vulnerability.severity);
            setSeverity(foundSeverity || null);
          }
          
          // Restore tags
          if (parsedData.tagNames && Array.isArray(parsedData.tagNames)) {
            const foundTags = tagsList.filter(t => parsedData.tagNames.includes(t.name));
            setTags(foundTags);
          } else {
            const foundCategories = tagsList.filter((c: TagItem) => vulnerability.tags.includes(c.name));
            setTags(foundCategories);
          }
          
          // Restore protocol and company
          if (parsedData.protocolId) {
            const foundProtocol = protocolsList.find(p => p.id === parsedData.protocolId);
            if (foundProtocol) {
              setProtocol(foundProtocol);
              const foundCompany = companiesList.find(c => c.id === foundProtocol.companyId);
              if (foundCompany) setCompany(foundCompany);
            }
          } else {
            const foundCompany = companiesList.find((c: CompanyItem) => c.name === vulnerability.companyName);
            setCompany(foundCompany || null);
            const foundProtocol = protocolsList.find((p: ProtocolItem) => p.name === vulnerability.protocolName);
            setProtocol(foundProtocol || null);
          }
          
          // Restore auditor
          if (parsedData.auditorId) {
            const foundAuditor = auditorsList.find(a => a.id === parsedData.auditorId);
            setAuditor(foundAuditor || null);
          } else {
            const foundAuditor = auditorsList.find((a: AuditorItem) => a.name === vulnerability.auditorName);
            setAuditor(foundAuditor || null);
          }
          
          // Restore source
          if (parsedData.sourceId) {
            const foundSource = sourceList.find(s => s.id === parsedData.sourceId);
            setSource(foundSource || null);
          } else {
            const foundSource = sourceList.find((s: VulnerabilitySource) => s.name === vulnerability.reportName);
            setSource(foundSource || null);
          }
        } catch (error) {
          console.error('Error loading saved form data:', error);
          // Fall back to original vulnerability data
          setTitle(vulnerability.title);
          setDescription(vulnerability.description);
          setReportUrl(vulnerability.reportUrl || '');
          const foundSeverity = severitiesList.find((s: VulnerabilitySeverity) => s.name === vulnerability.severity);
          setSeverity(foundSeverity || null);
          const foundCategories = tagsList.filter((c: TagItem) => vulnerability.tags.includes(c.name));
          setTags(foundCategories);
          const foundCompany = companiesList.find((c: CompanyItem) => c.name === vulnerability.companyName);
          setCompany(foundCompany || null);
          const foundProtocol = protocolsList.find((p: ProtocolItem) => p.name === vulnerability.protocolName);
          setProtocol(foundProtocol || null);
          const foundAuditor = auditorsList.find((a: AuditorItem) => a.name === vulnerability.auditorName);
          setAuditor(foundAuditor || null);
          const foundSource = sourceList.find((s: VulnerabilitySource) => s.name === vulnerability.reportName);
          setSource(foundSource || null);
          setCategory(vulnerability.category);
        }
      } else {
        // No saved data, use vulnerability data
        setTitle(vulnerability.title);
        setDescription(vulnerability.description);
        setReportUrl(vulnerability.reportUrl || '');
        const foundSeverity = severitiesList.find((s: VulnerabilitySeverity) => s.name === vulnerability.severity);
        setSeverity(foundSeverity || null);
        const foundCategories = tagsList.filter((c: TagItem) => vulnerability.tags.includes(c.name));
        setTags(foundCategories);
        const foundCompany = companiesList.find((c: CompanyItem) => c.name === vulnerability.companyName);
        setCompany(foundCompany || null);
        const foundProtocol = protocolsList.find((p: ProtocolItem) => p.name === vulnerability.protocolName);
        setProtocol(foundProtocol || null);
        const foundAuditor = auditorsList.find((a: AuditorItem) => a.name === vulnerability.auditorName);
        setAuditor(foundAuditor || null);
        const foundSource = sourceList.find((s: VulnerabilitySource) => s.name === vulnerability.reportName);
        setSource(foundSource || null);
        setCategory(vulnerability.category);
      }
      setIsFormLoaded(true);
    }
  }, [vulnerability, severitiesList, tagsList, protocolsList, companiesList, auditorsList, sourceList, storageKey]);

  // Save form data to sessionStorage whenever it changes
  useEffect(() => {
    if (isFormLoaded && vulnerability) {
      const formData = {
        title,
        reportUrl,
        description,
        category,
        severityName: severity?.name,
        tagNames: tags.map(t => t.name),
        protocolId: protocol?.id,
        auditorId: auditor?.id,
        sourceId: source?.id,
      };
      sessionStorage.setItem(storageKey, JSON.stringify(formData));
    }
  }, [title, reportUrl, description, category, severity, tags, protocol, auditor, source, isFormLoaded, vulnerability, storageKey]);

  const handleEditVulnerability = async () => {
    if (!vulnerability) return;

    const updatedVulnerability: Vulnerability = {
      ...vulnerability,
      title: title,
      description: description,
      severity: severity?.name || '',
      tags: tags.map(c => c.name),
      companyName: company?.name || '',
      companyId: company?.id || -1,
      protocolName: protocol?.name || '',
      protocolId: protocol?.id || -1,
      auditorName: auditor?.name || '',
      auditorId: auditor?.id || -1,
      reportName: source?.name || '',
      reportId: source?.id || -1,
      reportUrl: reportUrl,
      category: category === null ? VulnerabilityCategory.NA : category,
    };

    if (!updatedVulnerability.title || 
      !updatedVulnerability.description || 
      !updatedVulnerability.severity ||
      !updatedVulnerability.companyName || 
      !updatedVulnerability.protocolName || 
      !updatedVulnerability.auditorName ||
      updatedVulnerability.category === null) {
      showError('Please fill all required fields');
      return;
    }

    const success = await editVulnerability(updatedVulnerability, selectedImages.length > 0 ? selectedImages : undefined);
    if (success) {
      sessionStorage.removeItem(storageKey);
      navigate('/admin/vulnerabilities');
    } else {
      showError('Failed to update vulnerability');
    }
  };

  const validateAndAddImage = (file: File) => {
    // Check if file is an image
    if (!file.type.startsWith('image/')) {
      setImageError('Please select image files only');
      return;
    }
    
    // Check file size (max 5MB per image)
    if (file.size > 5 * 1024 * 1024) {
      setImageError('Each image must be less than 5MB');
      return;
    }

    // Check if total images (existing + new) would exceed 5
    if (existingImages.length + selectedImages.length >= 5) {
      setImageError('Maximum 5 images allowed (including existing images)');
      return;
    }
    
    setSelectedImages(prev => [...prev, file]);
    setImageError('');
  };

  const handleImageSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (files) {
      Array.from(files).forEach(file => {
        validateAndAddImage(file);
      });
    }
  };

  const handleDragOver = (event: React.DragEvent<HTMLDivElement>) => {
    event.preventDefault();
    setIsDragOver(true);
  };

  const handleDragLeave = (event: React.DragEvent<HTMLDivElement>) => {
    event.preventDefault();
    setIsDragOver(false);
  };

  const handleDrop = (event: React.DragEvent<HTMLDivElement>) => {
    event.preventDefault();
    setIsDragOver(false);
    
    const files = event.dataTransfer.files;
    Array.from(files).forEach(file => {
      validateAndAddImage(file);
    });
  };

  const handleRemoveImage = (index: number) => {
    setSelectedImages(prev => prev.filter((_, i) => i !== index));
    setImageError('');
  };

  const handleDeleteExistingImageConfirmed = async () => {
    if (existingImageToDelete && vulnerability?.picturesContainerGuid) {
      await deleteImage(vulnerability.picturesContainerGuid, existingImageToDelete);
      setExistingImageToDelete(null);
    }
  };

  const handleRemoveSelectedImageConfirmed = () => {
    if (selectedImageToRemove !== null) {
      handleRemoveImage(selectedImageToRemove);
      setSelectedImageToRemove(null);
    }
  };

  const handleCopyToClipboard = async (text: string) => {
    try {
      await navigator.clipboard.writeText(text);
      // You could add a toast notification here if you have one
    } catch (err) {
      console.error('Failed to copy to clipboard:', err);
    }
  };

  if (!vulnerability) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '50vh' }}>
        <Typography variant="h6">Loading vulnerability...</Typography>
      </Box>
    );
  }

  return (
    <Box sx={{ minHeight: '100vh', justifyContent: 'center' }}>
      <Paper
        elevation={6}
        sx={{
          width: '100%',
          maxWidth: 1200,
          minWidth: 320,
          mx: 'auto',
          borderRadius: 5,
          overflow: 'hidden',
        }}
      >
        <CardHeader
          avatar={
            <Avatar sx={{ bgcolor: theme.palette.primary.main, width: 56, height: 56 }}>
              <BugReportIcon fontSize="large" />
            </Avatar>
          }
          title={<Typography variant="h4" sx={{ fontWeight: 700, color: 'background.default' }}>Edit Vulnerability</Typography>}
          subheader={<Typography variant="subtitle1" sx={{ color: 'background.default' }}>Update vulnerability information</Typography>}
          sx={{ bgcolor: theme.palette.primary.light, px: 4, py: 3, borderBottom: `1px solid ${theme.palette.divider}` }}
        />
        <CardContent sx={{ px: { xs: 2, sm: 4, md: 6 }, py: { xs: 2, sm: 4 } }}>
          <Grid container spacing={4}>
            {/* Basic Information Section */}
            <Grid size={12}>
              <Box sx={{ bgcolor: 'background.default', px: 2, py: 1.5, borderRadius: 2, mb: 2 }}>
                <Typography variant="subtitle1" sx={{ fontWeight: 600, color: 'primary.contrastText' }}>
                  Basic Information
                </Typography>
              </Box>
            </Grid>
            <Grid size={12}>
              <TextField
                fullWidth
                size="small"
                variant="outlined"
                label="Title"
                value={title}
                onChange={e => setTitle(e.target.value)}
                required
              />
            </Grid>
            <Grid size={12}>
              <MarkdownEditor
                value={description}
                onChange={setDescription}
                label="Description"
                required
              />
            </Grid>

            {/* Classification Section */}
            <Grid size={12}>
              <Box sx={{ bgcolor: 'background.default', px: 2, py: 1.5, borderRadius: 2, mb: 2, mt: 1 }}>
                <Typography variant="subtitle1" sx={{ fontWeight: 600, color: 'primary.contrastText' }}>
                  Classification
                </Typography>
              </Box>
            </Grid>
            <Grid size={12}>
              <Autocomplete
                options={severitiesList}
                value={severity}
                onChange={(_, newValue) => setSeverity(newValue)}
                getOptionLabel={(option) => (option as VulnerabilitySeverity).name}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="Severity *"
                    size="small"
                    sx={{ width: '100%' }}
                  />
                )}
              />
            </Grid>
            <Grid size={12}>
              <Autocomplete
                multiple
                options={tagsList}
                value={tags}
                onChange={(_, newValue) => setTags(newValue as TagItem[])}
                getOptionLabel={(option) => (option as TagItem).name}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="Tags"
                    size="small"
                    sx={{ width: '100%' }}
                  />
                )}
                renderTags={(value, getTagProps) =>
                  value.map((option, index) => (
                    <Chip
                      {...getTagProps({ index })}
                      key={index}
                      label={(option as TagItem).name}
                      size="small"
                      sx={{
                        bgcolor: (option as TagItem).bgColor,
                        color: (option as TagItem).textColor,
                        fontWeight: 700,
                      }}
                    />
                  ))
                }
              />
            </Grid>
            <Grid size={12}>
              <Autocomplete
                options={Object.entries(VulnerabilityCategories).map(([_, value]) => value)}
                value={category !== null ? VulnerabilityCategories.find(c => c.id === category) || null : null}
                onChange={(_, newValue) => setCategory(newValue ? newValue.id : null)}
                getOptionLabel={(option) => (option as VulnerabilityCategoryInfo).label}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="Category *"
                    size="small"
                    sx={{ width: '100%' }}
                  />
                )}
              />
            </Grid>
            <Grid size={12}>
              <Autocomplete
                options={protocolsList}
                value={protocol}
                onChange={(_, newValue) => handleSetProtocol(newValue)}
                getOptionLabel={(option) => (option as ProtocolItem).name}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="Protocol *"
                    size="small"
                    sx={{ width: '100%' }}
                  />
                )}
              />
            </Grid>
            <Grid size={12}>
              <Autocomplete
                options={auditorsList}
                value={auditor}
                onChange={(_, newValue) => setAuditor(newValue)}
                getOptionLabel={(option) => (option as AuditorItem).name}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="Auditor *"
                    size="small"
                    sx={{ width: '100%' }}
                  />
                )}
              />
            </Grid>
            <Grid size={12}>
              <Autocomplete
                options={sourceList}
                value={source}
                onChange={(_, newValue) => setSource(newValue)}
                getOptionLabel={(option) => (option as VulnerabilitySource).name}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="Report *"
                    size="small"
                    sx={{ width: '100%' }}
                  />
                )}
              />
            </Grid>
            {
              source?.name === 'External' && (
                <Grid size={12}>
                <TextField
                  fullWidth
                  size="small"
                  variant="outlined"
                  label="Report URL"
                  value={reportUrl}
                  onChange={e => setReportUrl(e.target.value)}
                  placeholder="https://example.com/vulnerability-report"
                />
              </Grid>
            )}
            <Grid size={12}>
              <Box sx={{ bgcolor: 'background.default', px: 2, py: 1.5, borderRadius: 2, mb: 2, mt: 1 }}>
                <Typography variant="subtitle1" sx={{ fontWeight: 600, color: 'primary.contrastText' }}>
                  Existing Images ({existingImages.length}/5). Files Container Guid: {vulnerability?.picturesContainerGuid || 'N/A'}
                </Typography>
              </Box>
            </Grid>
            <Grid size={12}>
              {existingImages.length > 0 ? (
                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 2, justifyContent: 'center', mb: 3 }}>
                  {existingImages.map((image, index) => (
                    <Box
                      key={index}
                      sx={{
                        position: 'relative',
                        border: `2px solid ${theme.palette.divider}`,
                        borderRadius: 2,
                        overflow: 'hidden',
                        width: 200,
                        height: 320,
                        bgcolor: theme.palette.background.paper,
                        boxShadow: theme.shadows[2],
                      }}
                    >
                      <img
                        src={`${environment.apiUrl}/file/${vulnerability?.picturesContainerGuid || 'container'}/${image}`}
                        alt={`Existing Image ${index + 1}`}
                        style={{
                          width: '200px',
                          height: '180px',
                          objectFit: 'cover',
                        }}
                      />
                      <Box
                        sx={{
                          p: 1,
                          bgcolor: theme.palette.background.default,
                          borderTop: `1px solid ${theme.palette.divider}`,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          minHeight: 40,
                        }}
                      >
                        <Typography
                          variant="caption"
                          sx={{
                            fontSize: '0.7rem',
                            color: theme.palette.text.secondary,
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            flex: 1,
                            mr: 0.5,
                          }}
                        >
                          ![{image}]({environment.apiUrl}/file/{vulnerability?.picturesContainerGuid || 'container'}/{image})
                        </Typography>
                        <Box sx={{ display: 'flex', gap: 0.5 }}>
                          <Tooltip title="Copy filename">
                            <IconButton
                              size="small"
                              onClick={(e) => {
                                e.stopPropagation();
                                handleCopyToClipboard(`![${image}](${environment.apiUrl}/file/${vulnerability?.picturesContainerGuid || 'container'}/${image})`);
                              }}
                              sx={{
                                p: 0.5,
                                color: theme.palette.text.secondary,
                                '&:hover': {
                                  color: theme.palette.primary.main,
                                  bgcolor: theme.palette.action.hover,
                                },
                              }}
                            >
                              <ContentCopyIcon sx={{ fontSize: 14 }} />
                            </IconButton>
                          </Tooltip>
                          <Tooltip title="Delete image">
                            <IconButton
                              size="small"
                              onClick={(e) => {
                                e.stopPropagation();
                                setExistingImageToDelete(image);
                              }}
                              sx={{
                                p: 0.5,
                                color: theme.palette.error.main,
                                '&:hover': {
                                  bgcolor: theme.palette.error.light + '20',
                                },
                              }}
                            >
                              <DeleteIcon sx={{ fontSize: 14 }} />
                            </IconButton>
                          </Tooltip>
                        </Box>
                      </Box>
                    </Box>
                  ))}
                </Box>
              ) : (
                <Box sx={{ textAlign: 'center', py: 3, color: 'text.secondary' }}>
                  <Typography variant="body2">No existing images found</Typography>
                </Box>
              )}
            </Grid>
            <Grid size={12}>
              <Box sx={{ bgcolor: 'background.default', px: 2, py: 1.5, borderRadius: 2, mb: 2, mt: 1 }}>
                <Typography variant="subtitle1" sx={{ fontWeight: 600, color: 'primary.contrastText' }}>
                  Add New Images (Optional). Files Container Guid: {vulnerability?.picturesContainerGuid || 'N/A'}
                </Typography>
              </Box>
            </Grid>
            <Grid size={12}>
              <Box
                sx={{
                  border: `2px dashed ${isDragOver ? theme.palette.primary.main : theme.palette.divider}`,
                  borderRadius: 2,
                  p: 3,
                  textAlign: 'center',
                  cursor: 'pointer',
                  transition: 'all 0.2s ease-in-out',
                  backgroundColor: isDragOver ? theme.palette.primary.light + '20' : 'transparent',
                  ...(isDragOver && {
                    borderStyle: 'solid',
                    boxShadow: `0 0 0 2px ${theme.palette.primary.main}40`,
                    transform: 'scale(1.02)',
                  }),
                }}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                onClick={() => imageInputRef.current?.click()}
              >
                <input
                  ref={imageInputRef}
                  type="file"
                  accept="image/*"
                  multiple
                  onChange={handleImageSelect}
                  style={{ display: 'none' }}
                />
                {selectedImages.length === 0 ? (
                  <Box>
                    <CloudUploadIcon 
                      sx={{ 
                        fontSize: 48, 
                        color: isDragOver ? theme.palette.primary.main : theme.palette.text.secondary, 
                        mb: 2,
                        transition: 'color 0.2s ease-in-out'
                      }} 
                    />
                    <Typography variant="h6" sx={{ mb: 1 }}>
                      {isDragOver ? 'Drop images here' : 'Upload Images'}
                    </Typography>
                    <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                      Drag and drop up to {5 - existingImages.length} images here, or click to browse
                    </Typography>
                    <Button
                      variant="contained"
                      onClick={(e) => {
                        e.stopPropagation();
                        imageInputRef.current?.click();
                      }}
                      disabled={existingImages.length >= 5}
                    >
                      Choose Images
                    </Button>
                  </Box>
                ) : (
                  <Box>
                    <Typography variant="h6" sx={{ mb: 2 }}>
                      Selected Images ({selectedImages.length}/{5 - existingImages.length})
                    </Typography>
                    <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 2, justifyContent: 'center' }}>
                      {selectedImages.map((image, index) => (
                        <Box
                          key={index}
                          sx={{
                            position: 'relative',
                            border: `2px solid ${theme.palette.divider}`,
                            borderRadius: 2,
                            overflow: 'hidden',
                            width: 200,
                            height: 320,
                            bgcolor: theme.palette.background.paper,
                            boxShadow: theme.shadows[2],
                          }}
                        >
                          <img
                            src={URL.createObjectURL(image)}
                            alt={`Image ${index + 1}`}
                            style={{
                              width: '200px',
                              height: '180px',
                              objectFit: 'cover',
                            }}
                          />
                          <Box
                            sx={{
                              p: 1,
                              bgcolor: theme.palette.background.default,
                              borderTop: `1px solid ${theme.palette.divider}`,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              minHeight: 40,
                            }}
                          >
                            <Typography
                              variant="caption"
                              sx={{
                                fontSize: '0.7rem',
                                color: theme.palette.text.secondary,
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                flex: 1,
                                mr: 0.5,
                              }}
                            >
                              ![{image.name}]({environment.apiUrl}/file/{vulnerability?.picturesContainerGuid || 'container'}/{image.name})
                            </Typography>
                            <Box sx={{ display: 'flex', gap: 0.5 }}>
                              <Tooltip title="Copy filename">
                                <IconButton
                                  size="small"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleCopyToClipboard(`![${image.name}](${environment.apiUrl}/file/${vulnerability?.picturesContainerGuid || 'container'}/${image.name})`);
                                  }}
                                  sx={{
                                    p: 0.5,
                                    color: theme.palette.text.secondary,
                                    '&:hover': {
                                      color: theme.palette.primary.main,
                                      bgcolor: theme.palette.action.hover,
                                    },
                                  }}
                                >
                                  <ContentCopyIcon sx={{ fontSize: 14 }} />
                                </IconButton>
                              </Tooltip>
                              <Tooltip title="Remove image">
                                <IconButton
                                  size="small"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setSelectedImageToRemove(index);
                                  }}
                                  sx={{
                                    p: 0.5,
                                    color: theme.palette.error.main,
                                    '&:hover': {
                                      bgcolor: theme.palette.error.light + '20',
                                    },
                                  }}
                                >
                                  <DeleteIcon sx={{ fontSize: 14 }} />
                                </IconButton>
                              </Tooltip>
                            </Box>
                          </Box>
                        </Box>
                      ))}
                    </Box>
                    {selectedImages.length < (5 - existingImages.length) && (
                      <Button
                        variant="contained"
                        onClick={(e) => {
                          e.stopPropagation();
                          imageInputRef.current?.click();
                        }}
                      >
                        Add More Images
                      </Button>
                    )}
                  </Box>
                )}
              </Box>
              {imageError && (
                <Alert severity="error" sx={{ mt: 1 }}>
                  {imageError}
                </Alert>
              )}
              <Typography variant="caption" color="text.secondary" sx={{ mt: 1, display: 'block' }}>
                Maximum 5 images total (existing + new), 5MB each. Supported formats: JPG, PNG, GIF, WebP.
              </Typography>
            </Grid>
            <Grid size={12}>
              <Divider sx={{ my: 3 }} />
              <Box sx={{ display: 'flex', justifyContent: 'flex-end', gap: 2 }}>
                <Button
                  variant="contained"
                  onClick={() => navigate('/admin/vulnerabilities')}
                >
                  Cancel
                </Button>
                <Button
                  variant="contained"
                  color="success"
                  onClick={handleEditVulnerability}
                  disabled={isUploading}
                >
                  {isUploading ? 'Updating Vulnerability...' : 'Update Vulnerability'}
                </Button>
              </Box>
            </Grid>
          </Grid>
        </CardContent>
      </Paper>
      <ConfirmDialog
        title="Delete Image"
        message={`Are you sure you want to delete the image "${existingImageToDelete}"? This action cannot be undone.`}
        okButtonText="Delete"
        cancelButtonText="Cancel"
        show={!!existingImageToDelete}
        onConfirm={handleDeleteExistingImageConfirmed}
        onCancel={() => setExistingImageToDelete(null)}
      />
      <ConfirmDialog
        title="Remove Image"
        message={`Are you sure you want to remove the selected image "${selectedImageToRemove !== null ? selectedImages[selectedImageToRemove]?.name : ''}"? This action cannot be undone.`}
        okButtonText="Remove"
        cancelButtonText="Cancel"
        show={selectedImageToRemove !== null}
        onConfirm={handleRemoveSelectedImageConfirmed}
        onCancel={() => setSelectedImageToRemove(null)}
      />
    </Box>
  );
}; 