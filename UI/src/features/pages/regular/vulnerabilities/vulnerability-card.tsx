import { Box, Button, Card, CardContent, Chip, IconButton, Stack, Typography, Link as MuiLink, Modal, } from "@mui/material";
import { FC, useState } from "react";
import { CodeBlock } from "../../../../components/CodeBlock";
import { Report } from '../../../../api/soroban-security-portal/models/report';
import { ProtocolItem } from "../../../../api/soroban-security-portal/models/protocol";
import { getCategoryLabel, getCategoryColor } from "../../../../api/soroban-security-portal/models/vulnerability";
import CloseIcon from '@mui/icons-material/Close';
import ReactMarkdown from "react-markdown";
import remarkParse from "remark-parse";
import remarkGfm from "remark-gfm";
import rehypeKatex from "rehype-katex";
import rehypeRaw from "rehype-raw";
import remarkMath from "remark-math";
import remarkRehype from "remark-rehype";
import { useTheme } from "../../../../contexts/ThemeContext";

interface VulnerabilityCardProps {
    selectedVulnerability: any;
    reportsList: Report[];
    protocolsList: ProtocolItem[];
    handleCloseProfile: () => void;
    handleChipClick: (filterType: string, value: string) => void;
    handleDownloadReport: (reportId: number) => void;
    isModal?: boolean;
}

export const VulnerabilityCard: FC<VulnerabilityCardProps> = ({
    selectedVulnerability,
    reportsList,
    protocolsList,
    handleCloseProfile,
    handleChipClick,
    handleDownloadReport,
    isModal = false
}) => {
    const { themeMode } = useTheme();
    const [modalOpened, setModalOpened] = useState(isModal);

    const handleCloseModal = () => {
        setModalOpened(false);
        handleCloseProfile();
    };

    const content = (
        <Box sx={{
            width: isModal ? '100%' : '50%',
            overflow: 'auto',
            transition: 'width 0.3s ease-in-out',
            '&::-webkit-scrollbar': {
                width: '12px',
            },
            '&::-webkit-scrollbar-track': {
                backgroundColor: 'rgba(0, 0, 0, 0.1)',
                borderRadius: '4px',
            },
            '&::-webkit-scrollbar-thumb': {
                backgroundColor: 'rgba(0, 0, 0, 0.3)',
                borderRadius: '4px',
                '&:hover': {
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                },
            },
            '&::-webkit-scrollbar-corner': {
                backgroundColor: 'transparent',
            },
            pr: isModal ? 1 : 0,
            pt: isModal ? 2 : 0,
            pb: isModal ? 1 : 0,
        }}>
            <Box sx={{ pl: 1, pr: 1 }}>
                <Card sx={{
                    borderRadius: '20px',
                    border: '1px solid',
                    backgroundColor: themeMode === 'light' ? '#fafafa' : '#1A1A1A',
                    mb: 3
                }}>
                    <CardContent sx={{overflow: 'auto', height: '90vh'}}>
                        <Box sx={{ mb: 2, l: 2}}>
                            <Stack spacing={1}>
                                <Box sx={{ display: 'flex', flexDirection: 'row' }}>
                                    <Typography variant='h6' sx={{ fontWeight: 600, flexGrow: 1, textTransform: 'uppercase' }}>{selectedVulnerability.title}</Typography>
                                    <IconButton
                                        onClick={handleCloseProfile}
                                        sx={{
                                            color: themeMode === 'light' ? 'text.secondary' : 'text.disabled',
                                            '&:hover': {
                                                color: 'text.primary'
                                            }
                                        }}
                                    >
                                        <CloseIcon />
                                    </IconButton>
                                </Box>
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', height: '40px' }}>
                                    <Typography variant="body2" color="text.primary" component="div">Severity:
                                        <Chip
                                            label={selectedVulnerability.severity}
                                            size="small"
                                            sx={{
                                                marginLeft: '12px',
                                                border: '2px solid',
                                                backgroundColor: 'transparent',
                                                borderColor: (() => {
                                                    switch (selectedVulnerability.severity) {
                                                        case 'Critical': return '#c72e2b95';
                                                        case 'High': return '#FF6B3D95';
                                                        case 'Medium': return '#FFD84D95';
                                                        case 'Low': return '#569E6795';
                                                        case 'Note': return '#72F1FF95';
                                                        default: return '#e0e0e0';
                                                    }
                                                })(),
                                                fontWeight: 700,
                                                cursor: 'pointer',
                                                '&:hover': {
                                                    opacity: 0.8,
                                                    transform: 'scale(1.05)',
                                                    transition: 'all 0.2s ease-in-out'
                                                }
                                            }}
                                            onClick={() => handleChipClick('severity', selectedVulnerability.severity)}
                                        />
                                    </Typography>
                                </Box>
                                {(selectedVulnerability.reportName) && (
                                    <Box sx={{ display: 'flex', justifyContent: 'space-between', height: '32px' }}>
                                        <Typography variant="body2" color="text.primary" component="div">Report info:
                                            <Chip
                                                label={selectedVulnerability.reportName}
                                                size="small"
                                                sx={{
                                                    marginLeft: '12px',
                                                    border: '2px solid',
                                                    backgroundColor: 'transparent',
                                                    fontWeight: 700,
                                                    maxWidth: '250px',
                                                    overflow: 'hidden',
                                                    textOverflow: 'ellipsis',
                                                    whiteSpace: 'nowrap',
                                                    cursor: 'pointer',
                                                    '&:hover': {
                                                        opacity: 0.8,
                                                        transform: 'scale(1.05)',
                                                        transition: 'all 0.2s ease-in-out'
                                                    }
                                                }}
                                                onClick={() => handleChipClick('source', selectedVulnerability.reportName)}
                                            />
                                        </Typography>
                                        {selectedVulnerability.reportName === 'External' ? (
                                            <MuiLink
                                                href={selectedVulnerability.reportUrl}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                sx={{ textDecoration: 'none' }}
                                                onClick={(e) => e.stopPropagation()}
                                            >
                                                <Button
                                                    variant="contained"
                                                    size="small"
                                                    sx={{ textTransform: 'none', width: 150, height: 30 }}
                                                >
                                                    View Report
                                                </Button>
                                            </MuiLink>
                                        ) : (() => {
                                            const report = reportsList.find(report => report.name === selectedVulnerability.reportName);
                                            if (report) {
                                                return (
                                                    <Button
                                                        variant="contained"
                                                        size="small"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleDownloadReport(report.id);
                                                        }}
                                                        sx={{ textTransform: 'none', width: 150, height: 30 }}
                                                    >
                                                        Download Report
                                                    </Button>
                                                );
                                            }
                                            return (
                                                <Typography variant="caption" color="text.disabled">
                                                    No report available
                                                </Typography>
                                            );
                                        })()}
                                    </Box>
                                )}
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', height: '32px' }}>
                                    <Typography variant="body2" color="text.primary" component="div">Company:
                                        <Chip
                                            label={selectedVulnerability.companyName}
                                            size="small"
                                            sx={{
                                                marginLeft: '12px',
                                                border: '2px solid',
                                                backgroundColor: 'transparent',
                                                fontWeight: 700,
                                                cursor: 'pointer',
                                                '&:hover': {
                                                    opacity: 0.8,
                                                    transform: 'scale(1.05)',
                                                    transition: 'all 0.2s ease-in-out'
                                                }
                                            }}
                                            onClick={() => handleChipClick('company', selectedVulnerability.companyName)}
                                        />
                                    </Typography>
                                </Box>
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', height: '32px' }}>
                                    <Typography variant="body2" color="text.primary" component="div">Protocol:
                                        <Chip
                                            label={selectedVulnerability.protocolName}
                                            size="small"
                                            sx={{
                                                marginLeft: '12px',
                                                border: '2px solid',
                                                backgroundColor: 'transparent',
                                                fontWeight: 700,
                                                maxWidth: '250px',
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis',
                                                whiteSpace: 'nowrap',
                                                cursor: 'pointer',
                                                '&:hover': {
                                                    opacity: 0.8,
                                                    transform: 'scale(1.05)',
                                                    transition: 'all 0.2s ease-in-out'
                                                }
                                            }}
                                            onClick={() => handleChipClick('protocol', selectedVulnerability.protocolName)}
                                        />
                                    </Typography>
                                    <MuiLink
                                        href={(() => {
                                            const protocol = protocolsList.find(p => p.name === selectedVulnerability.protocolName);
                                            return protocol?.url || '#';
                                        })()}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        sx={{ textDecoration: 'none' }}
                                        onClick={(e) => {
                                            e.preventDefault();
                                            const protocol = protocolsList.find(p => p.name === selectedVulnerability.protocolName);
                                            if (protocol?.url) {
                                                window.open(protocol.url, '_blank');
                                            }
                                        }}
                                    >
                                        <Button
                                            variant="contained"
                                            size="small"
                                            sx={{
                                                color: 'background.default',
                                                borderColor: 'primary.main',
                                                backgroundColor: 'primary.main',
                                                textTransform: 'none',
                                                width: 150,
                                                height: 30,
                                                '&:hover': {
                                                    backgroundColor: 'rgba(250, 250, 250, 0.1)',
                                                    borderColor: 'primary.main',
                                                    color: 'primary.main',
                                                },
                                            }}
                                        >
                                            View source code
                                        </Button>
                                    </MuiLink>
                                </Box>
                                <Box sx={{ display: 'flex', justifyContent: 'space-between', height: '32px' }}>
                                    <Typography variant="body2" color="text.primary" component="div">Category:
                                        <Chip
                                            label={getCategoryLabel(selectedVulnerability.category)}
                                            size="small"
                                            sx={{
                                                marginLeft: '12px',
                                                border: '2px solid',
                                                backgroundColor: 'transparent',
                                                borderColor: getCategoryColor(selectedVulnerability.category),
                                                fontWeight: 700,
                                                cursor: 'pointer',
                                                '&:hover': {
                                                    opacity: 0.8,
                                                    transform: 'scale(1.05)',
                                                    transition: 'all 0.2s ease-in-out'
                                                }
                                            }}
                                        />
                                    </Typography>
                                </Box>
                            </Stack>
                        </Box>
                        <Box sx={{ mb: 2 }}>
                            <Typography variant="h6" sx={{ mb: 1, fontWeight: 600, textTransform: 'uppercase' }}>Description</Typography>
                            <Box sx={{
                                '& .katex-display': {
                                    margin: '1em 0 !important',
                                    textAlign: 'center',
                                    overflowX: 'auto',
                                    overflowY: 'hidden'
                                },
                                '& .katex': {
                                    fontSize: '1em !important',
                                    lineHeight: '1.2 !important'
                                },
                                '& .katex-inline': {
                                    display: 'inline !important',
                                    margin: '0 !important',
                                    padding: '0 !important'
                                }
                            }}>
                                <ReactMarkdown
                                    skipHtml={false}
                                    remarkPlugins={[remarkParse, remarkGfm, remarkMath, remarkRehype]}
                                    rehypePlugins={[rehypeRaw, rehypeKatex]}
                                    components={{
                                        code: (props) => {
                                            const { node, className, children, ...rest } = props;
                                            const inline = (props as any).inline;
                                            const match = /language-(\w+)/.exec(className || '');
                                            if (!inline && match) {
                                                return (
                                                    <CodeBlock className={className} {...rest}>
                                                        {String(children).replace(/\n$/, '')}
                                                    </CodeBlock>
                                                );
                                            } else {
                                                return (
                                                    <CodeBlock className={className} inline={true} {...rest}>
                                                        {String(children).replace(/\n$/, '')}
                                                    </CodeBlock>
                                                );
                                            }
                                        },
                                        // Handle inline math
                                        span: ({ className, children, ...props }) => {
                                            if (className && className.includes('math')) {
                                                return (
                                                    <span className={className} {...props}>
                                                        {children}
                                                    </span>
                                                );
                                            }
                                            return <span className={className} {...props}>{children}</span>;
                                        },
                                        // Handle block math
                                        div: ({ className, children, ...props }) => {
                                            if (className && className.includes('math')) {
                                                return (
                                                    <div className={className} {...props}>
                                                        {children}
                                                    </div>
                                                );
                                            }
                                            return <div className={className} {...props}>{children}</div>;
                                        }
                                    }}
                                >
                                    {selectedVulnerability.description
                                        // Convert escaped dollar signs to regular ones for math rendering
                                        .replace(/\\\$/g, '$')
                                    }
                                </ReactMarkdown>
                            </Box>
                        </Box>
                        <Box sx={{ display: 'flex', justifyContent: 'right' }}>
                            <Typography variant="body2" color="text.secondary">Discovered: {new Date(selectedVulnerability.date).toLocaleDateString()}</Typography>
                        </Box>
                    </CardContent>
                </Card>
            </Box>
        </Box>
    )
    return isModal ? (
        <Modal open={modalOpened} onClose={handleCloseModal}>
            {content}
        </Modal>
    ) : (
        content
    );
}