import { FC, useState } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  Button,
  Stack,
  Paper,
  TextField,
} from '@mui/material';
import {
  OpenInNew,
  Business,
  Assessment,
  Dashboard,
  BugReport,
  Bookmark,
  Person,
  Chat,
  Visibility,
  VisibilityOff,
  Send
} from '@mui/icons-material';
import { useNavigate } from 'react-router-dom';
import { useVulnerabilityDetails } from './hooks/vulnerability-details.hook';
import { useTheme as useAppTheme, SeverityColors } from '../../../../contexts/ThemeContext';
import { getCategoryLabel, getCategoryImage } from '../../../../api/soroban-security-portal/models/vulnerability';
import { environment } from '../../../../environments/environment';
import { MarkdownView } from '../../../../components/MarkdownView';
import { BookmarkButton } from '../../../../components/BookmarkButton';
import { BookmarkType } from '../../../../api/soroban-security-portal/models/bookmark';
import { useBookmarks } from '../../../../contexts/BookmarkContext';
import { useAppAuth } from '../../../authentication/useAppAuth';
import { EntityAvatar } from '../../../../components/EntityAvatar';
import {
  DetailPageLayout,
  StatisticsCards,
  DetailTabs,
  useDetailTabs,
} from '../../../../components/details';
import { formatDateLong } from '../../../../utils';
import { getSeverityColor } from '../../../../utils/color-utils';

export const VulnerabilityDetails: FC = () => {
  const navigate = useNavigate();
  const { isAuthenticated } = useAppAuth();
  const { themeMode } = useAppTheme();

  const {
    vulnerability,
    protocol,
    report,
    auditor,
    company,
    loading,
    error,
    vulnerabilityId,
    thread,
    threadLoading,
    addReply,
    toggleWatch,
  } = useVulnerabilityDetails();

  const { isBookmarked, toggleBookmark } = useBookmarks();
  const { tabValue, tabProps } = useDetailTabs(0);
  const [replyContent, setReplyContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleReplySubmit = async () => {
    if (!replyContent.trim()) return;
    setIsSubmitting(true);
    try {
      await addReply(replyContent);
      setReplyContent('');
    } catch (error) {
      console.error('Failed to submit reply', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // Configure statistics cards
  const statsCards = [
    {
      icon: <Assessment sx={{ fontSize: 40 }} />,
      iconColor: vulnerability ? getSeverityColor(vulnerability.severity) : SeverityColors['note'],
      value: vulnerability?.severity || 'Unknown',
      label: 'Severity Level',
    },
    {
      icon: <Business sx={{ fontSize: 40 }} />,
      iconColor: SeverityColors['low'],
      value: protocol?.name || 'Unknown',
      label: 'Protocol',
    },
    {
      icon: <Person sx={{ fontSize: 40 }} />,
      iconColor: SeverityColors['note'],
      value: auditor?.name || 'Unknown',
      label: 'Discovered By',
    },
  ];

  // Configure tabs
  const tabs = [
    { id: 'overview', label: 'Overview', icon: <Dashboard /> },
    { id: 'technical', label: 'Technical Details', icon: <BugReport /> },
    { id: 'discussion', label: `Discussion (${thread?.replies.length || 0})`, icon: <Chat /> },
  ];

  return (
    <DetailPageLayout
      loading={loading}
      error={error}
      entity={vulnerability}
      entityName="Vulnerability"
    >
      {vulnerability && (
        <>
          {/* Header */}
          <Box sx={{ mb: 3 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
              <img
                src={getCategoryImage(vulnerability.category)}
                alt={getCategoryLabel(vulnerability.category)}
                style={{ width: 50, height: 50, marginRight: 16 }}
              />
              <Box sx={{ flexGrow: 1 }}>
                <Typography
                  variant="h4"
                  sx={{
                    fontWeight: 600,
                    mb: 0.5,
                    wordBreak: 'break-word',
                    fontSize: { xs: '1.5rem', md: '2.125rem' },
                  }}
                >
                  {vulnerability.title}
                </Typography>
                <Typography variant="body1" color="text.secondary">
                  {vulnerability.severity} Vulnerability â€¢ ID #{vulnerabilityId}
                </Typography>
              </Box>
              {isAuthenticated && (
                <Stack direction="row" spacing={1} alignItems="center">
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={thread?.isUserWatching ? <VisibilityOff /> : <Visibility />}
                    onClick={toggleWatch}
                    sx={{
                      color: thread?.isUserWatching ? 'secondary.main' : 'primary.main',
                      borderColor: thread?.isUserWatching ? 'secondary.main' : 'primary.main',
                    }}
                  >
                    {thread?.isUserWatching ? 'Unwatch' : 'Watch Thread'}
                  </Button>
                  <BookmarkButton
                    itemId={vulnerabilityId}
                    bookmarkType={BookmarkType.Vulnerability}
                    isBookmarked={isBookmarked(vulnerabilityId, BookmarkType.Vulnerability)}
                    onToggle={toggleBookmark}
                  />
                </Stack>
              )}
            </Box>

            <Stack direction="row" spacing={2} sx={{ mb: 2, flexWrap: 'wrap', gap: 1 }}>
              <Typography
                variant="body2"
                color="text.secondary"
                sx={{ display: 'flex', alignItems: 'center' }}
              >
                Discovered: {formatDateLong(vulnerability.date)}
              </Typography>
            </Stack>
          </Box>

          {/* Statistics Cards */}
          <StatisticsCards cards={statsCards} columns={{ xs: 2, md: 3 }} />

          {/* Tabs */}
          <DetailTabs tabs={tabs} {...tabProps} />

          {/* Overview Tab Content */}
          {tabValue === 0 && (
            <Box
              sx={{
                display: 'flex',
                flexDirection: { xs: 'column', lg: 'row' },
                gap: 3,
              }}
            >
              {/* Main Content */}
              <Box sx={{ flex: 1 }}>
                {/* Vulnerability Details */}
                <Card sx={{ mb: 3, borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
                  <CardContent>
                    <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                      <Assessment sx={{ mr: 1, verticalAlign: 'middle' }} />
                      Vulnerability Details
                    </Typography>

                    <Box sx={{ mb: 3 }}>
                      <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
                        Description
                      </Typography>
                      <Paper
                        sx={{
                          p: 2,
                          backgroundColor: themeMode === 'light' ? '#fafafa' : '#1a1a1a',
                          border: '1px solid',
                          borderColor: 'divider',
                        }}
                      >
                        <MarkdownView content={vulnerability.description} sx={{ p: 0 }} />
                      </Paper>
                    </Box>
                  </CardContent>
                </Card>
              </Box>

              {/* Sidebar */}
              <Box sx={{ flex: { lg: 0.4 } }}>
                {/* Related Report */}
                {report && (
                  <Card sx={{ mb: 3, borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
                    <CardContent>
                      <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                        <Assessment sx={{ mr: 1, verticalAlign: 'middle' }} />
                        Audit Report
                      </Typography>

                      <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                        <EntityAvatar
                          entityType="report"
                          entityId={report.id}
                          size="medium"
                          fallbackText={report.name}
                          sx={{ mr: 2 }}
                        />
                        <Box sx={{ flexGrow: 1 }}>
                          <Typography variant="subtitle1" sx={{ fontWeight: 600 }}>
                            {report.name}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            Published: {formatDateLong(report.date)}
                          </Typography>
                        </Box>
                      </Box>

                      <Stack spacing={1}>
                        <Button
                          variant="contained"
                          startIcon={<OpenInNew />}
                          onClick={() => navigate(`/report/${report.id}`)}
                          fullWidth
                        >
                          View Full Report
                        </Button>

                        <Button
                          variant="contained"
                          startIcon={<OpenInNew />}
                          href={`${environment.apiUrl}/api/v1/reports/${report.id}/download`}
                          target="_blank"
                          rel="noopener noreferrer"
                          fullWidth
                        >
                          Download Report PDF
                        </Button>
                      </Stack>
                    </CardContent>
                  </Card>
                )}

                {/* Related Protocol */}
                {protocol && (
                  <Card sx={{ mb: 3, borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
                    <CardContent>
                      <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                        <Business sx={{ mr: 1, verticalAlign: 'middle' }} />
                        Protocol
                      </Typography>

                      <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                        <EntityAvatar
                          entityType="protocol"
                          entityId={protocol.id}
                          size="medium"
                          fallbackText={protocol.name}
                          sx={{ mr: 2 }}
                        />
                        <Box sx={{ flexGrow: 1 }}>
                          <Typography variant="subtitle1" sx={{ fontWeight: 600 }}>
                            {protocol.name}
                          </Typography>
                          {company && (
                            <Typography variant="body2" color="text.secondary">
                              by{' '}
                              <Typography
                                component="span"
                                variant="body2"
                                sx={{
                                  color: 'primary.main',
                                  cursor: 'pointer',
                                  textDecoration: 'underline',
                                  '&:hover': { color: 'primary.dark' },
                                }}
                                onClick={() => navigate(`/company/${company.id}`)}
                              >
                                {company.name}
                              </Typography>
                            </Typography>
                          )}
                        </Box>
                      </Box>

                      {protocol.description && (
                        <Typography
                          variant="body2"
                          color="text.secondary"
                          sx={{
                            mb: 2,
                            whiteSpace: 'pre-wrap',
                            lineHeight: 1.6,
                            display: '-webkit-box',
                            WebkitLineClamp: 3,
                            WebkitBoxOrient: 'vertical',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                          }}
                        >
                          {protocol.description}
                        </Typography>
                      )}

                      <Stack spacing={1}>
                        <Button
                          variant="contained"
                          startIcon={<OpenInNew />}
                          onClick={() => navigate(`/protocol/${protocol.id}`)}
                          fullWidth
                        >
                          View Protocol Details
                        </Button>

                        {protocol.url && (
                          <Button
                            variant="contained"
                            startIcon={<OpenInNew />}
                            href={protocol.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            fullWidth
                          >
                            Visit Protocol Website
                          </Button>
                        )}
                      </Stack>
                    </CardContent>
                  </Card>
                )}

                {/* Related Auditor */}
                {auditor && (
                  <Card sx={{ borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
                    <CardContent>
                      <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
                        <Person sx={{ mr: 1, verticalAlign: 'middle' }} />
                        Auditor
                      </Typography>

                      <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                        <EntityAvatar
                          entityType="auditor"
                          entityId={auditor.id}
                          size="medium"
                          fallbackText={auditor.name}
                          sx={{ mr: 2 }}
                        />
                        <Box sx={{ flexGrow: 1 }}>
                          <Typography variant="subtitle1" sx={{ fontWeight: 600 }}>
                            {auditor.name}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            Security Auditor
                          </Typography>
                        </Box>
                      </Box>

                      {auditor.description && (
                        <Typography
                          variant="body2"
                          color="text.secondary"
                          sx={{
                            mb: 2,
                            whiteSpace: 'pre-wrap',
                            lineHeight: 1.6,
                            display: '-webkit-box',
                            WebkitLineClamp: 3,
                            WebkitBoxOrient: 'vertical',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                          }}
                        >
                          {auditor.description}
                        </Typography>
                      )}

                      <Stack spacing={1}>
                        <Button
                          variant="contained"
                          startIcon={<OpenInNew />}
                          onClick={() => navigate(`/auditor/${auditor.id}`)}
                          fullWidth
                        >
                          View Auditor Profile
                        </Button>

                        {auditor.url && (
                          <Button
                            variant="contained"
                            startIcon={<OpenInNew />}
                            href={auditor.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            fullWidth
                          >
                            Visit Auditor Website
                          </Button>
                        )}
                      </Stack>
                    </CardContent>
                  </Card>
                )}
              </Box>
            </Box>
          )}

          {/* Technical Details Tab Content */}
          {tabValue === 1 && (
            <Box>
              <Card sx={{ borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 3, fontWeight: 600 }}>
                    <BugReport sx={{ mr: 1, verticalAlign: 'middle' }} />
                    Technical Analysis
                  </Typography>
                  <Stack spacing={3}>
                    {vulnerability.tags && vulnerability.tags.length > 0 && (
                      <Box>
                        <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
                          Tags
                        </Typography>
                        <Stack
                          direction="row"
                          spacing={1}
                          sx={{ flexWrap: 'wrap', gap: 1, mb: 2 }}
                        >
                          {vulnerability.tags.map((tag, index) => (
                            <Chip
                              key={index}
                              label={tag}
                              size="small"
                              sx={{ bgcolor: 'info.main', color: 'white' }}
                            />
                          ))}
                        </Stack>
                      </Box>
                    )}
                    {vulnerability.description && (
                      <Box>
                        <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 1 }}>
                          Description
                        </Typography>
                        <Paper
                          sx={{
                            p: 2,
                            backgroundColor: themeMode === 'light' ? '#fafafa' : '#1a1a1a',
                            border: '1px solid',
                            borderColor: 'divider',
                          }}
                        >
                          <MarkdownView content={vulnerability.description} sx={{ p: 0 }} />
                        </Paper>
                      </Box>
                    )}
                  </Stack>
                </CardContent>
              </Card>
            </Box>
          )}

          {/* Discussion Tab Content */}
          {tabValue === 2 && (
            <Box>
              <Card sx={{ borderRadius: 2, border: '1px solid', borderColor: 'divider' }}>
                <CardContent>
                  <Typography variant="h6" sx={{ mb: 3, fontWeight: 600 }}>
                    <Chat sx={{ mr: 1, verticalAlign: 'middle' }} />
                    Discussion
                  </Typography>

                  <Stack spacing={3} sx={{ mb: 4 }}>
                    {thread?.replies.length === 0 && (
                      <Typography variant="body1" color="text.secondary" sx={{ textAlign: 'center', py: 4 }}>
                        No replies yet. Be the first to start the discussion!
                      </Typography>
                    )}
                    {thread?.replies.map((reply) => (
                      <Paper
                        key={reply.id}
                        elevation={0}
                        sx={{
                          p: 2,
                          bgcolor: themeMode === 'light' ? '#f8f9fa' : '#1e1e1e',
                          border: '1px solid',
                          borderColor: 'divider',
                          borderRadius: 2,
                        }}
                      >
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                          <Typography variant="subtitle2" sx={{ fontWeight: 700 }}>
                            {reply.createdByName}
                          </Typography>
                          <Typography variant="caption" color="text.secondary">
                            {formatDateLong(reply.createdAt)}
                          </Typography>
                        </Box>
                        <Typography variant="body1" sx={{ whiteSpace: 'pre-wrap' }}>
                          {reply.content}
                        </Typography>
                      </Paper>
                    ))}
                  </Stack>

                  {isAuthenticated ? (
                    <Box sx={{ mt: 2 }}>
                      <TextField
                        fullWidth
                        multiline
                        rows={3}
                        placeholder="Type your reply here..."
                        variant="outlined"
                        value={replyContent}
                        onChange={(e) => setReplyContent(e.target.value)}
                        disabled={isSubmitting}
                        sx={{ mb: 2 }}
                      />
                      <Box sx={{ display: 'flex', justifyContent: 'flex-end' }}>
                        <Button
                          variant="contained"
                          startIcon={<Send />}
                          onClick={handleReplySubmit}
                          disabled={isSubmitting || !replyContent.trim()}
                        >
                          {isSubmitting ? 'Posting...' : 'Post Reply'}
                        </Button>
                      </Box>
                    </Box>
                  ) : (
                    <Paper sx={{ p: 2, textAlign: 'center', bgcolor: 'action.hover' }}>
                      <Typography variant="body2">
                        Please <Typography component="span" variant="body2" sx={{ color: 'primary.main', cursor: 'pointer', fontWeight: 600 }} onClick={() => navigate('/login')}>login</Typography> to join the discussion.
                      </Typography>
                    </Paper>
                  )}
                </CardContent>
              </Card>
            </Box>
          )}
        </>
      )}
    </DetailPageLayout>
  );
};
