import { CategoryColors } from '../../../theme';

export interface Vulnerability {
  id: number;
  title: string;
  description: string;
  severity: string;
  tags: string[];
  companyName: string;
  companyId: number;
  protocolName: string;
  protocolId: number;
  auditorName: string;
  auditorId: number;
  reportName: string;
  reportId: number;
  picturesContainerGuid: string;
  date: Date;
  status: string;
  reportUrl?: string; // Optional URL for detailed report
  images?: string[]; // Array of image URLs
  author?: string;
  lastActionBy?: string;
  lastActionAt?: string;
  category: VulnerabilityCategory;
}

export interface VulnerabilitySeverity {
  id: number;
  name: string;
}

export interface VulnerabilitySource {
  id: number;
  name: string;
  url: string;
  protocolId: number;
  auditorId: number;
}

export interface VulnerabilitySearch {
  severities?: string[]; 
  tags?: string[];
  reports?: string[]; 
  reportIds?: number[];
  protocols?: string[];
  protocolIds?: number[];
  companies?: string[];
  companyIds?: number[];
  auditors?: string[];
  auditorIds?: number[];
  searchText?: string; 
  from?: string;
  to?: string;
  sortBy?: 'date' | 'severity';
  sortDirection?: 'asc' | 'desc';
  page?: number;
  pageSize?: number;
  categories?: number[];
}

export interface VulnerabilityStatistics {
  total: number;
  bySeverity: Record<string, number>;
  byTag: Record<string, number>;
  byCategory: Record<string, number>;
}

export interface StatisticsChanges {
  total: number;
  new: number;
}

export enum VulnerabilityCategory {
  Valid = 0,
  ValidNotFixed = 1,
  ValidPartiallyFixed = 2,
  Invalid = 3,
  NA = 100
}

export interface VulnerabilityCategoryInfo {
  id: VulnerabilityCategory;
  label: string;
  color: string;
}

/**
 * Vulnerability category definitions with colorblind-accessible colors.
 * Colors use distinct hues rather than purple gradients for accessibility.
 *
 * @see CategoryColors in theme/constants.ts for color values
 */
export const VulnerabilityCategories: VulnerabilityCategoryInfo[] = [
  {
    id: VulnerabilityCategory.Valid,
    label: 'Valid (Fixed)',
    color: CategoryColors.valid
  },
  {
    id: VulnerabilityCategory.ValidNotFixed,
    label: 'Valid (Not Fixed)',
    color: CategoryColors.validNotFixed
  },
  {
    id: VulnerabilityCategory.ValidPartiallyFixed,
    label: 'Valid (Partially Fixed)',
    color: CategoryColors.validPartiallyFixed
  },
  {
    id: VulnerabilityCategory.Invalid,
    label: 'Invalid',
    color: CategoryColors.invalid
  },
  {
    id: VulnerabilityCategory.NA,
    label: 'N/A',
    color: CategoryColors.na
  }
];

export const AvailableVulnerabilityCategories = VulnerabilityCategories.filter(cat => cat.id !== VulnerabilityCategory.Invalid);

export function getCategoryLabel(category: VulnerabilityCategory): string {
  return AvailableVulnerabilityCategories[category]?.label || 'Unknown';
}

export function getCategoryColor(category: VulnerabilityCategory): string {
  return AvailableVulnerabilityCategories[category]?.color || CategoryColors.fallback;
}

export function getCategoryIdByLabel(label: string): VulnerabilityCategory | null {
  const normalized = label.trim().toLowerCase();

  let id: VulnerabilityCategory | null = null;

  // Match by human-readable label
  const byLabel = VulnerabilityCategories.find(c => c.label.toLowerCase() === normalized);
  if (byLabel) {
    id = byLabel.id;
  } else {
    // Match by enum member name (e.g., "ValidNotFixed")
    for (const key of Object.keys(VulnerabilityCategory).filter(k => isNaN(Number(k)))) {
      if (key.toLowerCase() === normalized) {
        id = (VulnerabilityCategory as any)[key] as VulnerabilityCategory;
        break;
      }
    }
  }

  // Conform to existing return pattern
  const entry: [string, unknown] | undefined = id !== null ? [String(id), null] : undefined;
  return entry ? Number(entry[0]) as VulnerabilityCategory : null;
}

export function getCategoryColorByLabel(label: string): string {
  const categoryId = getCategoryIdByLabel(label);
  if (categoryId !== null) {
    return getCategoryColor(categoryId);
  }
  return CategoryColors.fallback;
}

export function getCategoryImage(category: VulnerabilityCategory): string {
  const imageMap: { [key: number]: string } = {
    [VulnerabilityCategory.Valid]: '/static/images/vulnerability_categories/valid-fixed.png',
    [VulnerabilityCategory.ValidNotFixed]: '/static/images/vulnerability_categories/valid-not-fixed.png',
    [VulnerabilityCategory.ValidPartiallyFixed]: '/static/images/vulnerability_categories/valid-partially-fixed.png',
    [VulnerabilityCategory.Invalid]: '/static/images/vulnerability_categories/invalid.png',
    [VulnerabilityCategory.NA]: '/static/images/vulnerability_categories/invalid.png' // fallback to invalid
  };
  return imageMap[category] || '/static/images/vulnerability_categories/invalid.png';
}
